apiVersion: apps/v1
kind: Deployment
metadata:
  name: eliseo
  namespace: agents
  labels:
    app: eliseo
    role: agent
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: eliseo
  template:
    metadata:
      labels:
        app: eliseo
        role: agent
    spec:
      initContainers:
        - name: init-config
          image: node:22-bookworm-slim
          command: ["node", "-e"]
          args:
            - |
              const fs = require('fs');
              const e = process.env;
              const config = {
                gateway: {
                  port: 18789,
                  mode: "local",
                  bind: "lan",
                  auth: { mode: "token", token: e.OPENCLAW_GATEWAY_TOKEN || "" },
                  tools: { allow: ["sessions_spawn","sessions_send","sessions_list","sessions_history","session_status","cron"] },
                  controlUi: { dangerouslyAllowHostHeaderOriginFallback: true }
                },
                channels: {
                  discord: {
                    enabled: true,
                    token: e.DISCORD_TOKEN || "",
                    groupPolicy: "open",
                    dmPolicy: "pairing",
                    allowBots: true
                  }
                },
                models: {
                  providers: {
                    openrouter: {
                      baseUrl: "https://openrouter.ai/api/v1",
                      apiKey: e.OPENROUTER_API_KEY || "",
                      models: [
                        { id: "moonshotai/kimi-k2.5", name: "kimi-k2.5", api: "openai-completions", reasoning: true, input: ["text","image"], cost: { input: 0.45, output: 2.25, cacheRead: 0.07, cacheWrite: 0 }, contextWindow: 262144, maxTokens: 8192 }
                      ]
                    }
                  }
                },
                agents: {
                  defaults: {
                    model: { primary: "openrouter/moonshotai/kimi-k2.5" },
                    workspace: "/root/.openclaw/workspace",
                    compaction: { mode: "safeguard" },
                    maxConcurrent: 4,
                    subagents: { maxConcurrent: 4 }
                  }
                },
                tools: { sessions: { visibility: "all" } }
              };
              fs.mkdirSync('/root/.openclaw/workspace', { recursive: true });
              fs.mkdirSync('/root/.openclaw/skills', { recursive: true });
              fs.writeFileSync('/root/.openclaw/openclaw.json', JSON.stringify(config, null, 2));
              console.log('Eliseo config written OK');
          envFrom:
            - secretRef:
                name: eliseo-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
      containers:
        - name: openclaw
          image: ghcr.io/dante-alpha-assistant/openclaw-agent:latest
          ports:
            - containerPort: 18789
          envFrom:
            - secretRef:
                name: eliseo-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 2Gi
          livenessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 60
            periodSeconds: 15
          readinessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: eliseo-data
      imagePullSecrets:
        - name: ghcr-secret
