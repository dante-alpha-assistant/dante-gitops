apiVersion: apps/v1
kind: Deployment
metadata:
  name: ifra
  namespace: agents
  labels:
    app: ifra
    role: agent
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: ifra
  template:
    metadata:
      labels:
        app: ifra
        role: agent
    spec:
      initContainers:
        - name: init-config
          image: node:22-bookworm-slim
          command: ["node", "-e"]
          args:
            - |
              const fs = require('fs');
              const e = process.env;
              const config = {
                gateway: {
                  port: 18789,
                  mode: "local",
                  bind: "lan",
                  auth: { mode: "token", token: e.OPENCLAW_GATEWAY_TOKEN || "" },
                  tools: { allow: ["sessions_spawn","sessions_send","sessions_list","sessions_history","session_status","cron"] },
                  controlUi: { dangerouslyAllowHostHeaderOriginFallback: true }
                },
                channels: {
                  discord: {
                    enabled: true,
                    token: e.DISCORD_TOKEN || "",
                    groupPolicy: "open",
                    dmPolicy: "pairing",
                    allowBots: true
                  }
                },
                models: {
                  providers: {
                    anthropic: {
                      baseUrl: "https://api.anthropic.com",
                      apiKey: e.ANTHROPIC_API_KEY || "",
                      models: [
                        { id: "claude-opus-4-6", name: "claude-opus-4-6", api: "anthropic-messages", reasoning: true, input: ["text","image"], cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 }, contextWindow: 200000, maxTokens: 16384 }
                      ]
                    },
                    openrouter: {
                      baseUrl: "https://openrouter.ai/api/v1",
                      apiKey: e.OPENROUTER_API_KEY || "",
                      models: [
                        { id: "google/gemini-3-pro-preview", name: "gemini-3-pro-preview", api: "openai-completions", reasoning: false, input: ["text","image"], cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 }, contextWindow: 1048576, maxTokens: 8192 },
                        { id: "moonshotai/kimi-k2.5", name: "kimi-k2.5", api: "openai-completions", reasoning: true, input: ["text","image"], cost: { input: 0.45, output: 2.25, cacheRead: 0.07, cacheWrite: 0 }, contextWindow: 262144, maxTokens: 8192 }
                      ]
                    }
                  }
                },
                agents: {
                  defaults: {
                    model: { primary: "anthropic/claude-opus-4-6" },
                    workspace: "/root/.openclaw/workspace",
                    compaction: { mode: "safeguard" },
                    maxConcurrent: 4,
                    subagents: { maxConcurrent: 8 }
                  }
                },
                hooks: { enabled: true, token: "ifra-hooks-tok-2026", allowRequestSessionKey: true, defaultSessionKey: "hook:default", allowedSessionKeyPrefixes: ["hook:"] },
                tools: { sessions: { visibility: "all" } }
              };
              fs.mkdirSync('/root/.openclaw/workspace', { recursive: true });
              fs.mkdirSync('/root/.openclaw/skills', { recursive: true });
              fs.mkdirSync('/root/.openclaw/agents/main/agent', { recursive: true });
              fs.writeFileSync('/root/.openclaw/openclaw.json', JSON.stringify(config, null, 2));

              // Auth profiles â€” ensures OpenRouter is used, not Anthropic fallback
              const authProfiles = {
                "anthropic:default": {
                  type: "token",
                  provider: "anthropic",
                  token: e.ANTHROPIC_API_KEY || ""
                },
                "openrouter:default": {
                  type: "api_key",
                  provider: "openrouter",
                  key: e.OPENROUTER_API_KEY || ""
                }
              };
              fs.writeFileSync('/root/.openclaw/agents/main/agent/auth-profiles.json', JSON.stringify(authProfiles, null, 2));

              // SOUL.md -- DevOps engineer persona (only write if not exists, preserve agent edits)
              const soulPath = '/root/.openclaw/workspace/SOUL.md';
              if (!fs.existsSync(soulPath) || fs.readFileSync(soulPath, 'utf8').trim().length === 0) {
                const soul = [
                  "# SOUL.md - Ifra, DevOps Engineer",
                  "",
                  "## Identity",
                  "You are **Ifra**, the dedicated DevOps/Infrastructure engineer for Dante's AI agent fleet.",
                  "",
                  "## Role",
                  "You own ALL infrastructure, deployments, and operations:",
                  "- **ArgoCD** -- GitOps deployments, sync management, app health",
                  "- **Kubernetes (K3s)** -- pod management, scaling, debugging, resource allocation",
                  "- **Agent deployments** -- deploying new agents, fixing crash loops, config management",
                  "- **Services** -- MongoDB, Redis, task-dispatcher, queue-dashboard, any new infra",
                  "- **Networking** -- ingress, TLS certs (cert-manager), DNS coordination",
                  "- **GitOps repo** -- dante-gitops on GitHub is the single source of truth",
                  "- **Monitoring** -- pod health, log analysis, resource usage",
                  "",
                  "## Critical Rules",
                  "- **ALL changes go through GitOps.** Never edit K8s directly unless emergency (then backport immediately).",
                  "- **GitOps repo** dante-alpha-assistant/dante-gitops (agents/, infra/, apps/)",
                  "- **NEVER delete tasks from the task board.** Tasks are immutable history.",
                  "- **ALL work must go through a task on tasks.dante.id.** No side fixes.",
                  "- **ALWAYS tag agents in EVERY Discord message.** Agents only see @mentions.",
                  "",
                  "## Infrastructure Context",
                  "",
                  "### K8s Cluster",
                  "- Host 167.235.61.168 (Hetzner, K3s), SSH as root (key-based)",
                  "- Namespaces agents, infra, apps, kube-system, argocd",
                  "- Sealed Secrets kube-system/sealed-secrets, use kubeseal on server",
                  "- Cert-manager Let's Encrypt TLS",
                  "- Traefik ingress controller",
                  "",
                  "### Active Agents (agents namespace)",
                  "- Neo coder, kimi-k2.5, capacity 2, PVC",
                  "- Beta QA, kimi-k2.5, capacity 1, PVC",
                  "- Mu DISABLED",
                  "- Flow general purpose, Fernando's agent",
                  "- Ifra YOU",
                  "- Alpha Product owner, Dante's Mac (NOT in K8s)",
                  "",
                  "### Infra Services",
                  "- task-dispatcher Supabase Realtime, dispatches via /hooks/agent",
                  "- queue-dashboard tasks.dante.id (React + Express)",
                  "",
                  "### Supabase",
                  "- URL https://lessxkxujvcmublgwdaa.supabase.co",
                  "- Tables agent_tasks, agent_cards, agent_projects",
                  "",
                  "### DNS",
                  "- dante.id via Namecheap, all subdomains -> 167.235.61.168",
                  "",
                  "### Discord",
                  "- Agent Fleet 1471822298444206104, #general 1471822299203371030",
                  "- Perlea 1476656916641087658, #dante-agents 1476656995221111027",
                  "- IDs Alpha=1473014065503666268, Neo=1471821951663214737, Beta=1473023028890833019, Ifra=1477315872447008950, Dante=185059032531206146",
                  "",
                  "## Vibe",
                  "Calm, methodical, SRE mindset. You keep the platform running. Reliability > features.",
                ].join("\n");
                fs.writeFileSync(soulPath, soul);
              }

              // IDENTITY.md
              const idPath = '/root/.openclaw/workspace/IDENTITY.md';
              if (!fs.existsSync(idPath)) {
                fs.writeFileSync(idPath, '# IDENTITY.md\\n\\n- **Name:** Ifra\\n- **Creature:** DevOps Engineer\\n- **Emoji:** ðŸ”§\\n');
              }

              console.log('Config + SOUL + auth written OK');
          envFrom:
            - secretRef:
                name: ifra-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
      containers:
        - name: openclaw
          image: ghcr.io/dante-alpha-assistant/openclaw-agent:latest
          ports:
            - containerPort: 18789
          envFrom:
            - secretRef:
                name: ifra-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: ifra-data
      imagePullSecrets:
        - name: ghcr-secret
