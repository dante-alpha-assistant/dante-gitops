apiVersion: apps/v1
kind: Deployment
metadata:
  name: ifra-worker
  namespace: agents
  labels:
    app: ifra-worker
    role: worker
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: ifra-worker
  template:
    metadata:
      labels:
        app: ifra-worker
        role: worker
    spec:
      initContainers:
        - name: init-config
          image: node:22-bookworm-slim
          command: ["node", "-e"]
          args:
            - |
              const fs = require('fs');
              const e = process.env;
              const config = {
                gateway: {
                  port: 18789,
                  mode: "local",
                  bind: "lan",
                  auth: { mode: "token", token: e.OPENCLAW_GATEWAY_TOKEN || "" },
                  tools: { allow: ["sessions_spawn","sessions_send","sessions_list","sessions_history","session_status","cron"] },
                  controlUi: { dangerouslyAllowHostHeaderOriginFallback: true }
                },
                models: {
                  providers: {
                    anthropic: {
                      baseUrl: "https://api.anthropic.com",
                      apiKey: e.ANTHROPIC_API_KEY || "",
                      models: [
                        { id: "claude-opus-4-6", name: "claude-opus-4-6", api: "anthropic-messages", reasoning: true, input: ["text","image"], cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 }, contextWindow: 200000, maxTokens: 16384 }
                      ]
                    },
                    openrouter: {
                      baseUrl: "https://openrouter.ai/api/v1",
                      apiKey: e.OPENROUTER_API_KEY || "",
                      models: [
                        { id: "google/gemini-3-pro-preview", name: "gemini-3-pro-preview", api: "openai-completions", reasoning: false, input: ["text","image"], cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 }, contextWindow: 1048576, maxTokens: 8192 },
                        { id: "moonshotai/kimi-k2.5", name: "kimi-k2.5", api: "openai-completions", reasoning: true, input: ["text","image"], cost: { input: 0.45, output: 2.25, cacheRead: 0.07, cacheWrite: 0 }, contextWindow: 262144, maxTokens: 8192 }
                      ]
                    }
                  }
                },
                agents: {
                  defaults: {
                    model: { primary: "anthropic/claude-opus-4-6" },
                    workspace: "/root/.openclaw/workspace",
                    compaction: { mode: "safeguard" },
                    maxConcurrent: 8,
                    subagents: { maxConcurrent: 8 }
                  }
                },
                hooks: { enabled: true, token: "ifra-hooks-tok-2026", allowRequestSessionKey: true, defaultSessionKey: "hook:default", allowedSessionKeyPrefixes: ["hook:"] },
                tools: { sessions: { visibility: "all" } }
              };
              fs.mkdirSync('/root/.openclaw/workspace', { recursive: true });
              fs.mkdirSync('/root/.openclaw/skills', { recursive: true });
              fs.mkdirSync('/root/.openclaw/agents/main/agent', { recursive: true });
              fs.writeFileSync('/root/.openclaw/openclaw.json', JSON.stringify(config, null, 2));

              // Auth profiles
              const authProfiles = {
                "anthropic:default": {
                  type: "token",
                  provider: "anthropic",
                  token: e.ANTHROPIC_API_KEY || ""
                },
                "openrouter:default": {
                  type: "api_key",
                  provider: "openrouter",
                  key: e.OPENROUTER_API_KEY || ""
                }
              };
              fs.writeFileSync('/root/.openclaw/agents/main/agent/auth-profiles.json', JSON.stringify(authProfiles, null, 2));

              // SOUL.md
              const soulPath = '/root/.openclaw/workspace/SOUL.md';
              if (!fs.existsSync(soulPath) || fs.readFileSync(soulPath, 'utf8').trim().length === 0) {
                const soul = [
                  "# SOUL.md - Ifra Worker (Headless)",
                  "",
                  "## Identity",
                  "You are **Ifra**, a headless DevOps/Infrastructure worker for Dante's AI agent fleet.",
                  "You have NO Discord connection. You receive work exclusively via webhook hooks from the task dispatcher.",
                  "",
                  "## Role",
                  "You own ALL infrastructure, deployments, and operations:",
                  "- **ArgoCD** -- GitOps deployments, sync management, app health",
                  "- **Kubernetes (K3s)** -- pod management, scaling, debugging, resource allocation",
                  "- **Agent deployments** -- deploying new agents, fixing crash loops, config management",
                  "- **Services** -- MongoDB, Redis, task-dispatcher, queue-dashboard, any new infra",
                  "- **Networking** -- ingress, TLS certs (cert-manager), DNS coordination",
                  "- **GitOps repo** -- dante-gitops on GitHub is the single source of truth",
                  "",
                  "## Critical Rules",
                  "- **ALL changes go through GitOps.** Never edit K8s directly unless emergency.",
                  "- **NEVER delete tasks from the task board.** Tasks are immutable history.",
                  "- **ALL work must go through a task on tasks.dante.id.** No side fixes.",
                  "- Focus on the hook task. Complete it. Report back. No distractions.",
                  "",
                  "## Infrastructure Context",
                  "- K8s cluster: 167.235.61.168 (Hetzner, K3s), SSH as root (key-based)",
                  "- GitOps repo: dante-alpha-assistant/dante-gitops",
                  "- Namespaces: agents, infra, apps, kube-system, argocd",
                  "- Sealed Secrets: kube-system/sealed-secrets, use kubeseal on server",
                ].join("\n");
                fs.writeFileSync(soulPath, soul);
              }

              console.log('Ifra-worker headless config written OK');
          envFrom:
            - secretRef:
                name: ifra-worker-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
      containers:
        - name: openclaw
          image: ghcr.io/dante-alpha-assistant/openclaw-agent:latest
          ports:
            - containerPort: 18789
          envFrom:
            - secretRef:
                name: ifra-worker-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 18789
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: ifra-data
      imagePullSecrets:
        - name: ghcr-secret
