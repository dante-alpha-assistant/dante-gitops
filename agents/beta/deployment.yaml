apiVersion: apps/v1
kind: Deployment
metadata:
  name: beta
  namespace: agents
  labels:
    app: beta
    role: agent
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: beta
  template:
    metadata:
      labels:
        app: beta
        role: agent
    spec:
      initContainers:
        - name: init-config
          image: node:22-bookworm-slim
          command: ["sh", "-c"]
          args:
            - |
              mkdir -p /root/.openclaw/workspace /root/.openclaw/skills
              cat > /root/.openclaw/openclaw.json << EOCFG
              {
                "gateway": {
                  "port": 18789,
                  "mode": "local",
                  "bind": "lan",
                  "auth": { "mode": "token", "token": "${OPENCLAW_GATEWAY_TOKEN}" },
                  "tools": { "allow": ["sessions_spawn","sessions_send","sessions_list","sessions_history","session_status","cron"] }
                },
                "channels": {
                  "discord": {
                    "enabled": true,
                    "token": "${DISCORD_TOKEN}",
                    "guildId": "1471822298444206104",
                    "channelIds": ["1471822299203371030","1476656995221111027"],
                    "allowBots": true
                  }
                },
                "models": {
                  "providers": {
                    "anthropic": { "apiKey": "${ANTHROPIC_API_KEY}" },
                    "openrouter": { "apiKey": "${OPENROUTER_API_KEY}" },
                    "openai": { "apiKey": "${OPENAI_API_KEY}" }
                  }
                },
                "agents": {
                  "defaults": {
                    "model": { "primary": "anthropic/moonshotai/kimi-k2.5" },
                    "workspace": "/root/.openclaw/workspace",
                    "compaction": { "mode": "safeguard" },
                    "maxConcurrent": 4,
                    "subagents": { "maxConcurrent": 8 }
                  }
                },
                "tools": { "sessions": { "visibility": "all" } }
              }
              EOCFG
          envFrom:
            - secretRef:
                name: beta-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
      containers:
        - name: openclaw
          image: ghcr.io/dante-alpha-assistant/openclaw-agent:latest
          ports:
            - containerPort: 18789
          envFrom:
            - secretRef:
                name: beta-env
          volumeMounts:
            - name: data
              mountPath: /root/.openclaw
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: beta-data
      imagePullSecrets:
        - name: ghcr-secret
